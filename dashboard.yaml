views:
  - type: sections
    max_columns: 2
    title: Home Power
    path: sections
    sections:
      - type: grid
        cards:
          - type: heading
            heading: Actuals
          - type: tile
            entity: sensor.generator
            layout_options:
              grid_columns: 2
              grid_rows: 1
            visibility:
              - condition: numeric_state
                entity: sensor.generator
                above: 100
            show_entity_picture: false
            color: green
          - type: tile
            entity: sensor.generator_time_left
            visibility:
              - condition: numeric_state
                entity: sensor.generator
                above: 100
            color: green
          - type: gauge
            entity: sensor.battery_percent
            name: Battery
            unit: '%'
            min: 0
            max: 100
            needle: true
            severity:
              green: 80
              yellow: 20
              red: 0
          - type: entities
            entities:
              - entity: sensor.battery_remaining
                name: Time Remaining
              - entity: sensor.power_battery_used_kwh
                name: kWh Used
                icon: mdi:battery-10
              - entity: sensor.power_battery_remaining_kwh
                name: kWh Remaining
                icon: mdi:battery-60
            title: Battery
          - type: custom:mini-graph-card
            hours_to_show: 24
            points_per_hour: 1
            entities:
              - sensor.battery_load
            color_thresholds:
              - value: -12000
                color: '#ff0000'
              - value: -2000
                color: '#ff3300'
              - value: -1
                color: '#ff6666'
              - value: 0
                color: '#009900'
              - value: 12000
                color: '#00cc66'
          - graph: line
            type: sensor
            entity: sensor.net_solar_production
            detail: 2
            hours_to_show: 24
            name: Current Solar
          - graph: line
            type: sensor
            entity: sensor.ac_loads
            detail: 2
            theme: Fluent Red
            hours_to_show: 24
          - type: tile
            entity: sensor.total_daily_solar
            name: Solar In Today
            vertical: false
            icon: mdi:solar-power-variant
            show_entity_picture: false
            layout_options:
              grid_columns: 4
              grid_rows: 1
            hide_state: false
          - type: tile
            entity: switch.house_hotwater
            icon_tap_action:
              action: none
            state_content: last-changed
          - type: tile
            entity: sensor.house_hotwater_power
          - type: tile
            entity: switch.studio_hotwater
            icon_tap_action:
              action: none
            state_content: last-changed
          - type: tile
            entity: sensor.studio_hotwater_power
          - type: tile
            entity: humidifier.dehumidifier
            icon: mdi:toggle-switch-variant
            state_content: last-changed
            name: Master Bathroom Dehumidifier
          - graph: line
            type: sensor
            entity: sensor.hp2551ca_pro_v1_9_3_wh45_humidity
            detail: 2
            name: Master Bath Humidity
            unit: '%'
            theme: Fluent Blue
          - type: tile
            entity: sensor.vsr300_refresh_countdown_time_t
            name: HRV Refresh
            icon: mdi:air-purifier
            vertical: false
          - type: custom:mini-graph-card
            entities:
              - sensor.battery_temp
            show:
              labels: true
            color_thresholds:
              - value: 19
                color: '#0066ff'
              - value: 22
                color: '#339933'
              - value: 25
                color: '#ff0000'
            hours_to_show: 24
            points_per_hour: 1
            name: House Battery Temperature
      - type: grid
        cards:
          - type: heading
            heading: Forecast
          - type: weather-forecast
            entity: weather.forecast_home
            forecast_type: daily
          - type: custom:flex-table-card
            entities:
              include: sensor.solcast_7day_summary
            title: Solar Forecast
            columns:
              - name: Day
                data: summary
                modify: x.Day
                align: center
              - data: summary
                name: Worst kWh
                modify: x.pv10
                align: center
              - data: summary
                name: Estimated kWh
                modify: x.pv
                align: center
            css:
              table+: 'border-collapse: collapse;'
              th+: 'border: 1px solid white;'
              td+: 'border: 1px solid white;'
          - type: custom:apexcharts-card
            apex_config:
              chart:
                height: 350px
              legend:
                show: false
              xaxis:
                labels:
                  datetimeUTC: false
            all_series_config:
              unit: ' kWh'
            header:
              title: Solar forecast best and worst (P10)
              show: true
              standard_format: true
              show_states: true
              colorize_states: true
            graph_span: 3d
            span:
              start: day
              offset: '-0h'
            now:
              show: true
              label: Now
            yaxis:
              - id: kwh
                min: 0
                max: 16
                apex_config:
                  tickAmount: 5
              - id: header_only
                show: false
            series:
              - entity: sensor.solcast_pv_forecast_forecast_today
                yaxis_id: kwh
                type: line
                name: Today P10
                color: red
                group_by:
                  duration: 1h
                  func: sum
                data_generator: >
                  var today = entity.attributes.detailedForecast.map((start,
                  index) => {
                    return [new Date(start["period_start"]).getTime(), entity.attributes.detailedForecast[index]["pv_estimate10"]/2];
                  });

                  var data = today

                  return data;
                show:
                  legend_value: false
                  in_header: false
                stroke_width: 3
                float_precision: 2
                extend_to: false
              - entity: sensor.solcast_pv_forecast_forecast_today
                yaxis_id: kwh
                type: area
                name: Today
                color: orange
                group_by:
                  duration: 1h
                  func: sum
                data_generator: >
                  var today = entity.attributes.detailedForecast.map((start,
                  index) => {
                    return [new Date(start["period_start"]).getTime(), entity.attributes.detailedForecast[index]["pv_estimate"]/2];
                  });

                  var data = today

                  return data;
                show:
                  legend_value: false
                  in_header: false
                stroke_width: 3
                float_precision: 2
                extend_to: false
              - entity: sensor.solcast_pv_forecast_forecast_tomorrow
                yaxis_id: kwh
                type: line
                name: Tomorrow P10
                color: silver
                group_by:
                  duration: 1h
                  func: sum
                data_generator: >
                  var today = entity.attributes.detailedForecast.map((start,
                  index) => {
                    return [new Date(start["period_start"]).getTime(), entity.attributes.detailedForecast[index]["pv_estimate10"]/2];
                  });

                  var data = today

                  return data;
                show:
                  legend_value: false
                  in_header: false
                stroke_width: 3
                float_precision: 2
                extend_to: false
              - entity: sensor.solcast_pv_forecast_forecast_tomorrow
                yaxis_id: kwh
                type: area
                name: Tomorrow
                color: grey
                group_by:
                  duration: 1h
                  func: sum
                data_generator: >
                  var today = entity.attributes.detailedForecast.map((start,
                  index) => {
                    return [new Date(start["period_start"]).getTime(), entity.attributes.detailedForecast[index]["pv_estimate"]/2];
                  });

                  var data = today

                  return data;
                show:
                  legend_value: false
                  in_header: false
                stroke_width: 3
                float_precision: 2
                extend_to: false
              - entity: sensor.solcast_pv_forecast_forecast_day_3
                yaxis_id: kwh
                type: line
                name: Day After P10
                color: silver
                group_by:
                  duration: 1h
                  func: sum
                data_generator: >
                  var today = entity.attributes.detailedForecast.map((start,
                  index) => {
                    return [new Date(start["period_start"]).getTime(), entity.attributes.detailedForecast[index]["pv_estimate10"]/2];
                  });

                  var data = today

                  return data;
                show:
                  legend_value: false
                  in_header: false
                stroke_width: 3
                float_precision: 2
                extend_to: false
              - entity: sensor.solcast_pv_forecast_forecast_day_3
                yaxis_id: kwh
                type: area
                name: Day after
                color: grey
                group_by:
                  duration: 1h
                  func: sum
                data_generator: >
                  var today = entity.attributes.detailedForecast.map((start,
                  index) => {
                    return [new Date(start["period_start"]).getTime(), entity.attributes.detailedForecast[index]["pv_estimate"]/2];
                  });

                  var data = today

                  return data;
                show:
                  legend_value: false
                  in_header: false
                stroke_width: 3
                float_precision: 2
                extend_to: false
              - entity: sensor.solcast_pv_forecast_p10_remaining_today
                yaxis_id: header_only
                name: Remaining Today P10
                color: red
                show:
                  legend_value: true
                  in_header: true
                  in_chart: false
              - entity: sensor.solcast_pv_forecast_forecast_remaining_today
                yaxis_id: header_only
                name: Remaining Today
                color: orange
                show:
                  legend_value: true
                  in_header: true
                  in_chart: false
          - type: tile
            entity: sensor.solcast_pv_forecast_api_last_polled
            name: Solcast Last Update
          - type: tile
            entity: sensor.solcast_pv_forecast_api_used
            name: API Used
      - type: grid
        cards:
          - type: heading
            heading: Cat Shed
          - graph: line
            type: sensor
            entity: sensor.cat_shed_battery_percent
            detail: 1
            theme: Fluent Slate
            hours_to_show: 24
          - graph: line
            type: sensor
            entity: sensor.cat_shed_ac_loads
            detail: 2
            theme: Fluent Red
            hours_to_show: 24
          - graph: line
            type: sensor
            entity: sensor.cat_shed_net_solar_production
            detail: 2
            name: Cat Shed Solar
            hours_to_show: 24
          - graph: line
            type: sensor
            entity: sensor.cat_shed_battery_temp
            detail: 1
            theme: Fluent Blue
            hours_to_show: 24
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              - type: entities
                entities:
                  - entity: switch.tapo_power_02
                  - entity: sensor.tapo_power_02_current_consumption
                    name: Usage now
                  - entity: sensor.tapo_power_02_today_s_consumption
                    name: Today
                  - entity: sensor.tapo_power_02_this_month_s_consumption
                    name: This month
                state_color: true
              - type: entities
                entities:
                  - entity: input_number.kia_battery_percent_cut_off
                    name: Stop
                state_color: true
                title: Rules - House Battery Percent
            title: Kia charging controls
    cards: []
  - title: Configuration
    path: configuration
    type: sections
    sections:
      - type: grid
        cards:
          - type: heading
            heading: Battery Capacity and Excess
          - type: tile
            entity: input_number.power_battery_capacity
          - type: tile
            entity: input_number.power_typical_daily_kwh
            name: Typical Daily Use
          - type: tile
            entity: input_boolean.power_use_excess_for_house_air_con
            name: Excess for House Air Con
          - type: tile
            entity: input_boolean.power_use_excess_for_power_room_air_con
            name: Excess for Power Room Air Con
          - type: tile
            entity: input_boolean.power_use_excess_for_studio_hotwater
            name: Excess for Studio Hotwater
          - type: tile
            entity: input_boolean.studio_hotwater_override
            icon: mdi:toggle-switch-variant
      - type: grid
        cards:
          - type: heading
            heading: Battery State
          - type: tile
            entity: sensor.battery_percent
          - type: tile
            entity: input_boolean.power_excess
          - type: tile
            entity: input_boolean.power_low
          - square: false
            type: grid
            cards:
              - type: tile
                entity: sensor.net_solar_production
              - type: tile
                entity: sensor.solar_now_average
              - type: tile
                entity: sensor.power_battery_used_kwh
                name: Used
              - type: tile
                entity: sensor.solcast_pv_forecast_p10_remaining_today
                name: Remaining P10
              - type: tile
                entity: sensor.solcast_pv_forecast_forecast_remaining_today
                name: Remaining
            title: Triggers
            columns: 2
      - type: grid
        cards:
          - type: heading
            heading: Excess Start
          - type: tile
            entity: input_number.excess_battery_percent_start
            layout_options:
              grid_columns: 4
              grid_rows: 1
            name: Minimum start percent
          - type: tile
            entity: input_number.excess_solar_w_start
            layout_options:
              grid_columns: 4
              grid_rows: 1
            name: Minimum solar starting
          - type: tile
            entity: input_number.excess_extra_kwh_start
            layout_options:
              grid_columns: 4
              grid_rows: 1
            name: Minimum forecasted excess power for the day
          - type: tile
            entity: input_number.excess_extra_kwh_p10_start
            layout_options:
              grid_columns: 4
              grid_rows: 1
            name: Minimum P10 forecast excess for the day
          - type: tile
            entity: input_number.excess_battery_percent_on
            layout_options:
              grid_columns: 4
              grid_rows: 1
            name: Percent to automatically turn on
      - type: grid
        cards:
          - type: heading
            heading: Excess Stop
          - type: tile
            entity: input_number.excess_battery_percent_stop
            layout_options:
              grid_columns: 4
              grid_rows: 1
          - type: tile
            entity: input_number.excess_solar_w_stop
            layout_options:
              grid_columns: 4
              grid_rows: 1
          - type: tile
            entity: input_number.excess_extra_kwh_stop
            layout_options:
              grid_columns: 4
              grid_rows: 1
  - title: Today Detailed
    path: d
    cards:
      - type: custom:apexcharts-card
        update_interval: 1min
        header:
          title: Solar forecast
          show: true
          show_states: true
          colorize_states: true
        apex_config:
          chart:
            height: 500px
          tooltip:
            enabled: true
            shared: true
            intersect: false
            followCursor: true
            x:
              format: HH:mm
        now:
          show: true
          label: Now
        graph_span: 14h
        span:
          start: day
          offset: +5h
        yaxis:
          - id: capacity
            show: true
            opposite: true
            decimals: 0
            max: 100
            min: 0
            apex_config:
              tickAmount: 10
          - id: kWh
            show: true
            min: 0
            apex_config:
              tickAmount: 10
          - id: header_only
            show: false
        series:
          - entity: sensor.battery_percent
            yaxis_id: capacity
            type: line
            stroke_width: 2
            float_precision: 2
            color: DarkGreen
            extend_to: now
            group_by:
              func: avg
              duration: 30m
          - entity: sensor.net_solar_production
            transform: return x / 1000;
            name: Solar Power (now)
            type: line
            stroke_width: 2
            float_precision: 2
            color: Orange
            yaxis_id: kWh
            unit: kW
            extend_to: now
            show:
              legend_value: true
              in_header: true
            group_by:
              func: avg
              duration: 30m
          - entity: sensor.solcast_pv_forecast_forecast_today
            name: Forecast
            color: Grey
            opacity: 0.3
            stroke_width: 0
            type: area
            extend_to: false
            group_by:
              func: avg
              duration: 30m
            yaxis_id: kWh
            show:
              legend_value: false
              in_header: false
            data_generator: |
              return entity.attributes.detailedForecast.map((entry) => {
                    return [new Date(entry.period_start), entry.pv_estimate];
                  });
          - entity: sensor.solcast_pv_forecast_forecast_today
            name: Forecast 10%
            color: Grey
            opacity: 0.3
            stroke_width: 0
            type: area
            extend_to: false
            group_by:
              func: avg
              duration: 30m
            yaxis_id: kWh
            show:
              legend_value: false
              in_header: false
            data_generator: |
              return entity.attributes.detailedForecast.map((entry) => {
                    return [new Date(entry.period_start), entry.pv_estimate10];
                  });
          - entity: sensor.total_daily_solar
            yaxis_id: header_only
            name: Total Solar Today
            stroke_width: 2
            color: Orange
            show:
              legend_value: true
              in_header: true
              in_chart: false
          - entity: sensor.solcast_pv_forecast_forecast_today
            yaxis_id: header_only
            name: Today Forecast
            color: Grey
            show:
              legend_value: true
              in_header: true
              in_chart: false
          - entity: sensor.solcast_pv_forecast_forecast_today
            attribute: estimate10
            yaxis_id: header_only
            name: Today Forecast 10%
            color: Grey
            opacity: 0.3
            show:
              legend_value: true
              in_header: true
              in_chart: false
          - entity: sensor.solcast_pv_forecast_forecast_remaining_today
            yaxis_id: header_only
            name: Remaining
            color: Grey
            show:
              legend_value: true
              in_header: true
              in_chart: false
    type: panel
  - type: sections
    max_columns: 3
    title: House Power Monitoring
    path: house-power-monitoring
    icon: mdi:monitor-dashboard
    sections:
      - type: grid
        cards:
          - type: heading
            heading: Shelly Power Meter 1
          - type: tile
            entity: sensor.shelly_power_meter_1_em0_power
            grid_options:
              columns: full
              rows: 1
            name: Lights
          - type: tile
            entity: sensor.shelly_power_meter_1_em1_power
            grid_options:
              columns: full
            name: Power 1
          - type: tile
            entity: sensor.shelly_power_meter_2_em0_power
            grid_options:
              columns: full
            name: Power 2
          - type: tile
            entity: sensor.shelly_power_meter_2_em1_power
            grid_options:
              columns: full
            name: Power 3
          - type: tile
            entity: sensor.shelly_power_meter_3_em0_power
            grid_options:
              columns: full
            name: Oven
          - type: tile
            entity: sensor.shelly_power_meter_3_em1_power
            grid_options:
              columns: full
            name: Bio Tank
          - type: tile
            entity: sensor.shelly_power_meter_4_em0_power
            grid_options:
              columns: full
            name: Heat Recovery
          - type: tile
            entity: sensor.shelly_power_meter_4_em1_power
            grid_options:
              columns: full
            name: House Hotwater
          - type: tile
            entity: sensor.shelly_power_meter_5_em0_power
            grid_options:
              columns: full
            name: Cooktop
          - type: tile
            entity: sensor.shelly_power_meter_5_em1_power
            grid_options:
              columns: full
            name: House Airconditioner
      - type: grid
        cards:
          - type: heading
            heading: New section
          - type: history-graph
            entities:
              - entity: sensor.shelly_power_meter_1_em0_power
            title: Lights Power Usage Charts
      - type: grid
        cards:
          - type: heading
            heading: New section
          - type: history-graph
            entities:
              - entity: sensor.shelly_power_meter_1_em1_power
              - entity: sensor.shelly_power_meter_2_em0_power
              - entity: sensor.shelly_power_meter_2_em1_power
            title: Power Points
      - type: grid
        cards:
          - type: heading
            heading: New section
          - type: history-graph
            entities:
              - entity: sensor.shelly_power_meter_3_em0_power
              - entity: sensor.shelly_power_meter_5_em0_power
            title: Kitchen
      - type: grid
        cards:
          - type: heading
            heading: New section
          - type: history-graph
            entities:
              - entity: sensor.shelly_power_meter_3_em1_power
              - entity: sensor.shelly_power_meter_4_em0_power
              - entity: sensor.shelly_power_meter_4_em1_power
              - entity: sensor.shelly_power_meter_5_em1_power
            title: Utility
  - type: sections
    max_columns: 4
    title: Cat BMS
    path: cat-bms
    icon: ''
    sections:
      - type: grid
        cards:
          - type: heading
            heading: DL-40D63C34995A
          - type: tile
            entity: sensor.dl_40d63c34995a_battery
          - type: tile
            entity: binary_sensor.dl_40d63c34995a_charging
          - type: tile
            entity: sensor.dl_40d63c34995a_current
          - type: tile
            entity: sensor.dl_40d63c34995a_cycles
          - type: tile
            entity: sensor.dl_40d63c34995a_power
          - type: tile
            entity: sensor.dl_40d63c34995a_runtime
          - type: tile
            entity: sensor.dl_40d63c34995a_stored_energy
          - type: tile
            entity: sensor.dl_40d63c34995a_temperature
          - type: tile
            entity: sensor.dl_40d63c34995a_voltage
      - type: grid
        cards:
          - type: heading
            heading: DL-40D63C34995A
          - type: tile
            entity: sensor.dl_40d63c34995a_delta_voltage
          - type: history-graph
            entities:
              - entity: sensor.dl_40d63c34995a_delta_voltage
            title: Cell voltage difference
            hours_to_show: 72
          - type: history-graph
            entities:
              - entity: sensor.dl_40d63c34995a_voltage
            hours_to_show: 72
            title: Battery Voltage
          - type: history-graph
            entities:
              - entity: sensor.dl_40d63c34995a_current
            hours_to_show: 72
            title: Battery Voltage
    cards: []
  - type: sections
    max_columns: 2
    title: EV
    path: ev
    icon: mdi:ev-station
    sections:
      - type: grid
        cards:
          - type: picture-elements
            elements:
              - type: state-label
                entity: sensor.ev_charger_load
                style:
                  left: 60%
                  top: 62%
                  font-weight: bold
                  font-size: 18px
              - type: state-label
                entity: sensor.ev_charger_mode
                style:
                  left: 61%
                  top: 48%
                  font-weight: bold
                  font-size: 18px
              - type: state-label
                entity: sensor.ev_realtime_current
                style:
                  left: 62%
                  top: 55%
                  font-weight: bold
                  font-size: 18px
              - type: state-label
                style:
                  left: 17%
                  top: 30%
                  font-weight: bold
                  font-size: 28px
                entity: sensor.net_solar_production
              - type: state-label
                entity: sensor.ac_loads
                style:
                  left: 50%
                  top: 30%
                  font-weight: bold
                  font-size: 27px
              - type: state-label
                entity: sensor.battery_percent
                style:
                  left: 83%
                  top: 30%
                  font-weight: bold
                  font-size: 27px
              - type: state-label
                entity: sensor.solcast_pv_forecast_p10_remaining_today
                style:
                  left: 61%
                  top: 86%
                  font-weight: bold
                  font-size: 14px
              - type: state-label
                entity: sensor.solcast_pv_forecast_p10_tomorrow
                style:
                  left: 61%
                  top: 93%
                  font-weight: bold
                  font-size: 14px
              - type: state-label
                entity: sensor.solcast_pv_forecast_forecast_remaining_today
                style:
                  left: 85%
                  top: 86%
                  font-weight: bold
                  font-size: 14px
              - type: state-label
                entity: sensor.solcast_pv_forecast_forecast_tomorrow
                style:
                  left: 84%
                  top: 93%
                  font-weight: bold
                  font-size: 14px
              - type: state-label
                entity: sensor.ev_charger_state
                style:
                  left: 50%
                  top: 40%
                  font-weight: bold
                  font-size: 24px
            image: /api/image/serve/2d1cd26b5e9aaa68ff2e5d8d1d72f725/512x512
            title: EV Charger
      - type: grid
        cards:
          - type: heading
            heading: EV Charger
            heading_style: title
            icon: mdi:ev-station
          - type: history-graph
            entities:
              - entity: sensor.ev_charger_load
            hours_to_show: 24
          - type: history-graph
            entities:
              - entity: sensor.ev_charger_state
            hours_to_show: 48
            title: EV Charging State
      - type: grid
        cards:
          - type: heading
            heading: Set EV Charger
            heading_style: title
          - type: custom:mushroom-select-card
            entity: input_select.ev_charger_mode
            grid_options:
              columns: 6
              rows: 2
            secondary_info: none
          - show_name: true
            show_icon: false
            type: button
            tap_action:
              action: perform-action
              perform_action: script.ev_charger_change_mode
              target: {}
            entity: script.ev_charger_change_mode
            icon: mdi:ev-station
            show_state: false
            grid_options:
              columns: 6
              rows: 2
            hold_action:
              action: none
            name: Set Charge Mode
          - type: tile
            entity: script.start_ev_charger
            grid_options:
              columns: 6
              rows: 2
            visibility:
              - condition: state
                entity: sensor.ev_charger_startstop
                state: Stop
          - type: tile
            entity: script.stop_ev_charger
            grid_options:
              columns: 6
              rows: 2
            visibility:
              - condition: state
                entity: sensor.ev_charger_startstop
                state: Start
          - type: tile
            entity: number.cerbo_gx_ev_charger_set_current
            grid_options:
              columns: full
            features:
              - type: numeric-input
                style: buttons
          - type: tile
            entity: switch.cerbo_gx_ev_charger_start_stop
